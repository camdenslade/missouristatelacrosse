option_settings:
  aws:elasticbeanstalk:cloudwatch:logs:
    StreamLogs: true
    DeleteOnTerminate: false
    RetentionInDays: 7

files:
  "/etc/systemd/system/eb-docker-log.service":
    mode: "000644"
    owner: root
    group: root
    content: |
      [Unit]
      Description=Elastic Beanstalk Docker Log Service
      After=docker.service
      Requires=docker.service

      [Service]
      Type=simple
      Restart=always
      RestartSec=10
      ExecStart=/bin/sh -c 'while true; do CONTAINER_ID=$$(docker ps -q | head -1); if [ ! -z "$$CONTAINER_ID" ]; then docker logs -f $$CONTAINER_ID 2>&1 | tee -a /var/log/eb-docker/containers/eb-current-app/eb-stdouterr.log; else sleep 5; fi; done'
      StandardOutput=journal
      StandardError=journal

      [Install]
      WantedBy=multi-user.target

container_commands:
  01_create_log_directory:
    command: "mkdir -p /var/log/eb-docker/containers/eb-current-app && chmod -R 755 /var/log/eb-docker"
    ignoreErrors: true
  02_reload_systemd:
    command: "systemctl daemon-reload"
    ignoreErrors: true
  03_enable_service:
    command: "systemctl enable eb-docker-log.service"
    ignoreErrors: true
  04_start_service:
    command: "systemctl start eb-docker-log.service"
    ignoreErrors: true

